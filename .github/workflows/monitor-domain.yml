name: Monitor custom domain

on:
  schedule:
    - cron: '*/15 * * * *' # every 15 minutes
  workflow_dispatch:

jobs:
  check-domain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install requests

      - name: Run domain check
        id: domain_check
        env:
          DOMAIN: Albertcoolter.pl
        run: |
          python scripts/check_domain.py --domain "$DOMAIN" --ips 185.199.108.153 185.199.109.153 185.199.110.153 185.199.111.153 --interval 300 --timeout 86400

      - name: Create issue if domain is live
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOMAIN: Albertcoolter.pl
        run: |
          python - <<'PY'
import os, requests
repo = os.environ['GITHUB_REPOSITORY']
title = f"{os.environ['DOMAIN']} is now resolving"
headers = {'Authorization': f"token {os.environ['GITHUB_TOKEN']}", 'Accept': 'application/vnd.github+json'}
# Search for existing open issue with same title
q = f"repo:{repo} in:title '{title}' state:open"
sr = requests.get('https://api.github.com/search/issues', params={'q': q}, headers=headers)
if sr.status_code != 200:
    print('Failed to search issues', sr.status_code, sr.text)
else:
    if sr.json().get('total_count', 0) == 0:
        body = f'The custom domain {os.environ['DOMAIN']} appears to be resolving to the expected IPs. Please verify TLS provisioning and site content.'
        pr = requests.post(f'https://api.github.com/repos/{repo}/issues', json={'title': title, 'body': body}, headers=headers)
        print('Issue create status', pr.status_code)
    else:
        print('An open issue already exists')
PY